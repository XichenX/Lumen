name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0 æˆ– v1.0.0/develop
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0). Leave empty for auto-increment'
        required: false
      auto_increment:
        description: 'Auto increment patch version (e.g., 1.0.0 -> 1.0.1)'
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•ç”¨äºç‰ˆæœ¬æ£€æµ‹
          token: ${{ secrets.GITHUB_TOKEN }}  # ç”¨äºæ¨é€ç‰ˆæœ¬å·å˜æ›´
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Extract version from tag
        id: extract_version
        if: github.event_name == 'push'
        run: |
          # ä» tag æå–ç‰ˆæœ¬å·ï¼Œæ”¯æŒæ ¼å¼ï¼š
          # - v1.0.0 -> 1.0.0
          # - v1.0.0/develop -> 1.0.0
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}  # ç§»é™¤ v å‰ç¼€
          VERSION=${VERSION%%/*}  # ç§»é™¤ /develop ç­‰åç¼€
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"
      
      - name: Get current version from gradle.properties
        id: current_version
        run: |
          CURRENT_VERSION=$(grep "^VERSION_NAME=" gradle.properties | cut -d'=' -f2 || echo "0.0.0")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in gradle.properties: $CURRENT_VERSION"
      
      - name: Determine final version
        id: final_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            CURRENT="${{ steps.current_version.outputs.current_version }}"
            
            if [ -n "${{ github.event.inputs.version }}" ]; then
              # æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·
              FINAL_VERSION="${{ github.event.inputs.version }}"
              echo "Using manually specified version: $FINAL_VERSION"
            elif [ "${{ github.event.inputs.auto_increment }}" == "true" ]; then
              # è‡ªåŠ¨é€’å¢ patch ç‰ˆæœ¬
              FINAL_VERSION=$(echo "$CURRENT" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
              echo "Auto-incremented version: $CURRENT -> $FINAL_VERSION"
            else
              # ä½¿ç”¨å½“å‰ç‰ˆæœ¬å·
              FINAL_VERSION="$CURRENT"
              echo "Using current version: $FINAL_VERSION"
            fi
          else
            # Tag è§¦å‘
            TAG_VERSION="${{ steps.extract_version.outputs.version }}"
            CURRENT="${{ steps.current_version.outputs.current_version }}"
            
            # å¦‚æœ tag ç‰ˆæœ¬ä¸å½“å‰ç‰ˆæœ¬ç›¸åŒï¼Œè‡ªåŠ¨é€’å¢ patch
            if [ "$TAG_VERSION" == "$CURRENT" ]; then
              FINAL_VERSION=$(echo "$CURRENT" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
              echo "Tag version ($TAG_VERSION) matches current ($CURRENT), auto-incrementing to: $FINAL_VERSION"
            else
              FINAL_VERSION="$TAG_VERSION"
              echo "Using tag version: $FINAL_VERSION (current: $CURRENT)"
            fi
          fi
          
          echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Final version to publish: $FINAL_VERSION"
      
      - name: Update version in gradle.properties
        run: |
          VERSION=${{ steps.final_version.outputs.final_version }}
          sed -i "s/^VERSION_NAME=.*/VERSION_NAME=$VERSION/" gradle.properties
          echo "Updated VERSION_NAME to $VERSION"
          cat gradle.properties | grep VERSION_NAME
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build and test
        run: ./gradlew clean build test --parallel --max-workers=4 --stacktrace
      
      - name: Setup GPG
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
            echo "GPG key imported successfully"
            
            # æå–å¯†é’¥ ID
            KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep -E "^(sec|SEC)" | head -1 | awk '{print $2}' | cut -d'/' -f2)
            echo "GPG_KEY_ID=$KEY_ID" >> $GITHUB_ENV
            echo "GPG Key ID: $KEY_ID"
            
            # å¯¼å‡ºå¯†é’¥æ–‡ä»¶ç”¨äº Gradle ç­¾å
            gpg --export-secret-keys --armor "$KEY_ID" > secret.gpg
            echo "GPG key exported to secret.gpg"
          else
            echo "Warning: GPG_PRIVATE_KEY not set, signing will be skipped"
            echo "GPG_KEY_ID=" >> $GITHUB_ENV
          fi
      
      - name: Publish to Maven Central
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SIGNING_KEY_ID: ${{ env.GPG_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.GPG_PASSPHRASE }}
          SIGNING_SECRET_KEY_RING_FILE: secret.gpg
        run: |
          if [ -n "$SONATYPE_USERNAME" ] && [ -n "$SONATYPE_PASSWORD" ]; then
            echo "Publishing to Maven Central..."
            echo "Publishing modules: lumen-core, lumen-view, lumen-transform, lumen"
            echo "Using optimized parallel publishing with dependency management..."
            
            # ä½¿ç”¨èšåˆä»»åŠ¡ + å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–
            # Gradle ä¼šè‡ªåŠ¨å¤„ç†ä»»åŠ¡ä¾èµ–ï¼Œåœ¨æ»¡è¶³ä¾èµ–çš„å‰æä¸‹æœ€å¤§åŒ–å¹¶è¡Œ
            # --parallel: å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡
            # --max-workers: æ§åˆ¶å¹¶è¡Œåº¦ï¼ˆ4ä¸ªæ¨¡å—ï¼Œä½†å—ä¾èµ–é™åˆ¶ï¼‰
            ./gradlew publishAllToMavenCentral \
                      --parallel \
                      --max-workers=4 \
                      --stacktrace
            
            echo "âœ… Published successfully to Maven Central!"
            echo ""
            echo "Next steps:"
            echo "1. Login to https://s01.oss.sonatype.org"
            echo "2. Go to Staging Repositories"
            echo "3. Find your repository and click Close"
            echo "4. Wait for validation, then click Release"
            echo "5. Wait for sync to Maven Central (usually a few hours)"
          else
            echo "âš ï¸  Sonatype credentials not configured, skipping Maven Central publish"
            echo "Building artifacts for manual upload..."
            # ä½¿ç”¨èšåˆä»»åŠ¡ + å¹¶è¡Œæ‰§è¡Œ
            ./gradlew publishAllToMavenLocal \
                      --parallel \
                      --max-workers=4
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/build/publications/**/*.pom
            **/build/publications/**/*.aar
            **/build/publications/**/*.jar
            **/build/publications/**/*.asc
          retention-days: 30
      
      - name: Commit version update back to repository
        if: github.event_name == 'push' && success()
        run: |
          VERSION=${{ steps.final_version.outputs.final_version }}
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥ gradle.properties æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --quiet gradle.properties; then
            echo "Version change detected, committing update to repository"
            git add gradle.properties
            git commit -m "chore: bump version to $VERSION [skip ci]"
            
            # è·å–å½“å‰åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯ main æˆ– masterï¼‰
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "Pushing version update to $BRANCH branch"
            git push origin HEAD:$BRANCH || echo "Note: Version update push skipped (may already be up to date or no permission)"
          else
            echo "No version change detected in gradle.properties, skipping commit"
          fi
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release v${{ steps.final_version.outputs.final_version }}
          body: |
            ## ğŸ“¦ Maven Central Release
            
            Version: **${{ steps.final_version.outputs.final_version }}**
            
            ### ğŸ“‹ Published Modules
            
            - âœ… **lumen-core** - Core loading logic
            - âœ… **lumen-view** - ImageView and Compose support
            - âœ… **lumen-transform** - Image transformation features
            - âœ… **lumen** - Aggregated module (includes all sub-modules)
            
            ### ğŸš€ Usage
            
            ```kotlin
            repositories {
                mavenCentral()
            }
            
            dependencies {
                // èšåˆæ¨¡å—ï¼ˆæ¨èï¼‰- è‡ªåŠ¨åŒ…å«æ‰€æœ‰å­æ¨¡å—
                implementation("io.github.xichenx:lumen:${{ steps.final_version.outputs.final_version }}")
                
                // æˆ–ç‹¬ç«‹æ¨¡å—
                implementation("io.github.xichenx:lumen-core:${{ steps.final_version.outputs.final_version }}")
                implementation("io.github.xichenx:lumen-view:${{ steps.final_version.outputs.final_version }}")
                implementation("io.github.xichenx:lumen-transform:${{ steps.final_version.outputs.final_version }}")
            }
            ```
            
            ### ğŸ“ Next Steps
            
            1. Login to [Sonatype](https://s01.oss.sonatype.org)
            2. Go to **Staging Repositories**
            3. Find your repository and click **Close**
            4. Wait for validation, then click **Release**
            5. Wait for sync to Maven Central (usually a few hours)
            
            ### ğŸ”— Links
            
            - [Maven Central](https://repo1.maven.org/maven2/io/github/xichenx/)
            - [Sonatype Staging](https://s01.oss.sonatype.org)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

